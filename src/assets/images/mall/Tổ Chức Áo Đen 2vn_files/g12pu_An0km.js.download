if (self.CavalryLogger) { CavalryLogger.start_js(["SAk+a"]); }

__d("MUFILiveCommentActivity.react",["cx","CSS","MCache","MLegacyDataStore","MParent","MUFICommentTypingIndicator.react","MUFINewCommentsSocialPill.react","MUFITypingIndicatorPill.react","MViewport","React","Stratcom","SubscriptionsHandler"],(function(a,b,c,d,e,f,g){"use strict";var h=b("React"),i=40,j=15,k="_mufiseencomments";a=function(a){babelHelpers.inheritsLoose(c,a);function c(c,d){d=a.call(this,c,d)||this;d.cacheID=c.feedbackTargetID+k;var e={},f=b("MCache").getItem(d.cacheID);Array.isArray(f)&&f.forEach(function(a){e[a]=!0});var g=[],h=[];c.comments.forEach(function(a){a in e?g.push(a):h.push(a)});d.state={seenCommentIDs:g,unseenCommentIDs:h,showPill:!1};return d}var d=c.prototype;d.UNSAFE_componentWillReceiveProps=function(a){var b={};this.state.seenCommentIDs.forEach(function(a){b[a]=!0});var c=a.comments.filter(function(a){return!(a in b)});this.setupScrollListenerAndPillState(a.comments,c)};d.componentDidMount=function(){this.setupScrollListenerAndPillState(this.props.comments,this.state.unseenCommentIDs)};d.setupScrollListenerAndPillState=function(a,c){this.scrollArea=b("MParent").bySigil(this.refs.root,"scroll-area");this.clearScrollListener();var d=!1,e=this.state.seenCommentIDs;c.length?this.isCommentVisible(c[0])?(this.highlightComments(c),e=a,c=[]):(d=!0,this.startScrollListener()):this.props.isAnyLiveTyping&&!this.isTypingIndicatorCellVisible()&&(d=!0,this.startScrollListener());this.setState({showPill:d,seenCommentIDs:e,unseenCommentIDs:c})};d.componentWillUnmount=function(){this.clearScrollListener(),b("MCache").setItem(this.cacheID,this.state.seenCommentIDs.slice())};d.onScroll=function(a){this.state.unseenCommentIDs.length&&this.isCommentVisible(this.state.unseenCommentIDs[0])?(this.clearScrollListener(),this.highlightComments(this.state.unseenCommentIDs),this.setState({seenCommentIDs:this.props.comments,unseenCommentIDs:[],showPill:!1})):this.props.isAnyLiveTyping&&this.isTypingIndicatorCellVisible()&&(this.clearScrollListener(),this.setState({showPill:!1}))};d.clearScrollListener=function(){this.scrollHandler&&this.scrollHandler.release(),this.scrollHandler=null};d.startScrollListener=function(){this.scrollHandler||(this.scrollHandler=new(b("SubscriptionsHandler"))(),this.scrollHandler.addSubscriptions(b("Stratcom").listen(this.scrollArea?"MScrollArea:scroll":"scroll",null,this.onScroll.bind(this))))};d.isCommentVisible=function(a){a=this.getCommentElement(a);return this.isElementAboveViewportBottom(a,i)};d.isTypingIndicatorCellVisible=function(){return this.isElementAboveViewportBottom(this.typingIndicatorElement,j)};d.isElementAboveViewportBottom=function(a,c){if(!a)return!1;a=this.getElementTop(a);var d=this.scrollArea?this.scrollArea.offsetHeight:b("MViewport").getScreenHeight();return a+c<d};d.getElementTop=function(a){a=a.getBoundingClientRect().top;this.scrollArea&&(a-=this.scrollArea.getBoundingClientRect().top);return a};d.getCommentElement=function(a){a=a&&a.split("_")[1];return a?document.getElementById(a):null};d.scrollToNode=function(a){if(this.scrollArea){var c=b("MLegacyDataStore").get(this.scrollArea).scrollArea;c.scrollTo(0,Math.min(this.getElementTop(a),c.getMaxScrollTop()))}else a.scrollIntoView()};d.highlightComments=function(a){a.forEach(function(a){a=this.getCommentElement(a);a&&(b("CSS").addClass(a,"_1vcf"),b("CSS").addClass(a,"_625u"))},this)};d.onNewCommentPillClick=function(a){a.preventDefault();this.clearScrollListener();this.highlightComments(this.state.unseenCommentIDs);a=this.getCommentElement(this.state.unseenCommentIDs[0]);a&&this.scrollToNode(a);this.setState({seenCommentIDs:this.props.comments,unseenCommentIDs:[],showPill:!1})};d.onTypingIndicatorPillClick=function(a){a.preventDefault(),this.clearScrollListener(),this.typingIndicatorElement&&this.scrollToNode(this.typingIndicatorElement),this.setState({showPill:!1})};d.renderPill=function(){if(this.props.disablePill)return null;var a=null;this.state.unseenCommentIDs.length?a=h.jsx(b("MUFINewCommentsSocialPill.react"),{commentIDs:this.state.unseenCommentIDs,onClick:this.onNewCommentPillClick.bind(this)}):this.props.isAnyLiveTyping&&(a=h.jsx(b("MUFITypingIndicatorPill.react"),{onClick:this.onTypingIndicatorPillClick.bind(this)}));return!a?null:h.jsx("div",{className:"_5t1e","data-sigil":"mufi-pill-overlay",children:a},"pill")};d.renderTypingIndicator=function(){var a=this;return h.jsx("div",{ref:function(b){return a.typingIndicatorElement=b},children:h.jsx(b("MUFICommentTypingIndicator.react"),{})})};d.render=function(){return h.jsxs("div",{ref:"root",children:[this.props.isAnyLiveTyping?this.renderTypingIndicator():null,this.state.showPill?this.renderPill():null]})};return c}(h.Component);e.exports=a}),null);